---
title: "final"
author: "Everett Mahaffy"
format:
  html:
    toc: true
    embed-resources: true
    highlight-style: cyan
execute:
  eval: true
  echo: false
warning: false
message: false
---

# Packages
```{r}
library(tidyverse)
library(dplyr)
library(lme4)
library(lmerTest)
library(performance)
library(gg)
library(RColorBrewer)
```

# Read in data
```{r}
df <- read.csv("dyad_mean_data_all.csv")
```

# Linear models

## RQ1. Are dyad members’ mean levels of inter-personal ER strategy use positively associated across the daily diary period?

### models
```{r}
## PROBLEM SOLVING
rq1a_problem_solving <- lm(
  ad_inter_problem_solving_avg ~ par_inter_problem_solving_avg +
    ad_age + ad_gender + time_spent_avg + par_negative_affect + ad_negative_affect,
  data = df
)
summary(rq1a_problem_solving)
check_model(rq1a_problem_solving, check = c("linearity","outliers","vif","qq","homogeneity"))

## CORUMINATION
rq1a_corumination <- lm(
  ad_inter_corumination_avg ~ par_inter_corumination_avg +
    ad_age + ad_gender + time_spent_avg + par_negative_affect + ad_negative_affect,
  data = df
)
summary(rq1a_corumination)
check_model(rq1a_corumination, check = c("linearity","outliers","vif","qq","homogeneity"))

## REAPPRAISAL
rq1a_reappraisal <- lm(
  ad_inter_reappraisal_avg ~ par_inter_reappraisal_avg +
    ad_age + ad_gender + time_spent_avg + par_negative_affect + ad_negative_affect,
  data = df
)
summary(rq1a_reappraisal)
check_model(rq1a_reappraisal, check = c("linearity","outliers","vif","qq","homogeneity"))

## ACCEPTANCE
rq1a_acceptance <- lm(
  ad_inter_acceptance_avg ~ par_inter_acceptance_avg +
    ad_age + ad_gender + time_spent_avg + par_negative_affect + ad_negative_affect,
  data = df
)
summary(rq1a_acceptance)
check_model(rq1a_acceptance, check = c("linearity","outliers","vif","qq","homogeneity"))

## DISTRACTION
rq1a_distraction <- lm(
  ad_inter_distraction_avg ~ par_inter_distraction_avg +
    ad_age + ad_gender + time_spent_avg + par_negative_affect + ad_negative_affect,
  data = df
)
summary(rq1a_distraction)
check_model(rq1a_distraction, check = c("linearity","outliers","vif","qq","homogeneity"))

## SUPPRESSION
rq1a_suppression <- lm(
  ad_inter_suppression_avg ~ par_inter_suppression_avg +
    ad_age + ad_gender + time_spent_avg + par_negative_affect + ad_negative_affect,
  data = df
)
summary(rq1a_suppression)
check_model(rq1a_suppression, check = c("linearity","outliers","vif","qq","homogeneity"))
```

### summary and fdr

```{r}
modelsummary(
  list(
    "problem solving" = rq1a_problem_solving,
    "corumination"    = rq1a_corumination,
    "reappraisal"     = rq1a_reappraisal,
    "acceptance"      = rq1a_acceptance,
    "distraction"     = rq1a_distraction,
    "suppression"     = rq1a_suppression
  ),
  stars = TRUE,
  title = "RQ1a: Inter-personal ER strategy use similarity across the daily diary period",
  notes = "All models adjust for adolescent age, gender, time spent together, parent NA, and adolescent NA"
)

confint(rq1a_problem_solving, level = 0.95)
confint(rq1a_corumination, level = 0.95)
confint(rq1a_reappraisal, level = 0.95)
confint(rq1a_acceptance, level = 0.95)
confint(rq1a_distraction, level = 0.95)
confint(rq1a_suppression, level = 0.95)

rq1a_models <- list(
  problem_solving = rq1a_problem_solving,
  corumination    = rq1a_corumination,
  reappraisal     = rq1a_reappraisal,
  acceptance      = rq1a_acceptance,
  distraction     = rq1a_distraction,
  suppression     = rq1a_suppression
)

rq1a_preds <- c(
  "par_inter_problem_solving_avg",
  "par_inter_corumination_avg",
  "par_inter_reappraisal_avg",
  "par_inter_acceptance_avg",
  "par_inter_distraction_avg",
  "par_inter_suppression_avg"
)

rq1a_tests <- data.frame(
  model     = names(rq1a_models),
  predictor = rq1a_preds,
  stringsAsFactors = FALSE
)

rq1a_tests$p_raw <- mapply(function(m, p) {
  coef(summary(rq1a_models[[m]]))[p, "Pr(>|t|)"]
}, rq1a_tests$model, rq1a_tests$predictor)

rq1a_tests <- rq1a_tests %>%
  mutate(
    p_fdr  = p.adjust(p_raw, method = "BH"),
    signif = p_fdr < 0.05
  )

print(rq1a_tests)
modelsummary(
  list(
    "problem solving" = rq1a_problem_solving,
    "corumination"    = rq1a_corumination,
    "reappraisal"     = rq1a_reappraisal,
    "acceptance"      = rq1a_acceptance,
    "distraction"     = rq1a_distraction,
    "suppression"     = rq1a_suppression
  ),
  stars = TRUE,
  title = "RQ1a: Inter-personal ER strategy use similarity across the daily diary period",
  notes = "All models adjust for adolescent age, gender, time spent together, parent NA, and adolescent NA"
)

confint(rq1a_problem_solving, level = 0.95)
confint(rq1a_corumination, level = 0.95)
confint(rq1a_reappraisal, level = 0.95)
confint(rq1a_acceptance, level = 0.95)
confint(rq1a_distraction, level = 0.95)
confint(rq1a_suppression, level = 0.95)

rq1a_models <- list(
  problem_solving = rq1a_problem_solving,
  corumination    = rq1a_corumination,
  reappraisal     = rq1a_reappraisal,
  acceptance      = rq1a_acceptance,
  distraction     = rq1a_distraction,
  suppression     = rq1a_suppression
)

rq1a_preds <- c(
  "par_inter_problem_solving_avg",
  "par_inter_corumination_avg",
  "par_inter_reappraisal_avg",
  "par_inter_acceptance_avg",
  "par_inter_distraction_avg",
  "par_inter_suppression_avg"
)

rq1a_tests <- data.frame(
  model     = names(rq1a_models),
  predictor = rq1a_preds,
  stringsAsFactors = FALSE
)

rq1a_tests$p_raw <- mapply(function(m, p) {
  coef(summary(rq1a_models[[m]]))[p, "Pr(>|t|)"]
}, rq1a_tests$model, rq1a_tests$predictor)

rq1a_tests <- rq1a_tests %>%
  mutate(
    p_fdr  = p.adjust(p_raw, method = "BH"),
    signif = p_fdr < 0.05
  )

print(rq1a_tests)
```

## RQ2. Are dyad members’ mean levels of intra-personal ER strategy use positively associated across the daily diary period?

### models

```{r}
## RQ2a: Intra-personal ER strategy use similarity across the daily diary period

## PROBLEM SOLVING
rq2a_problem_solving <- lm(
  ad_intra_problem_solving_avg ~ par_intra_problem_solving_avg +
    ad_age + ad_gender + time_spent_avg + par_negative_affect + ad_negative_affect,
  data = df
)
summary(rq2a_problem_solving)
check_model(rq2a_problem_solving, check =c("linearity","outliers","vif","qq","homogeneity"))

## RUMINATION
rq2a_rumination <- lm(
  ad_intra_rumination_avg ~ par_intra_rumination_avg +
    ad_age + ad_gender + time_spent_avg + par_negative_affect + ad_negative_affect,
  data = df
)
summary(rq2a_rumination)
check_model(rq2a_rumination, check = c("linearity","outliers","vif","qq","homogeneity"))

## REAPPRAISAL
rq2a_reappraisal <- lm(
  ad_intra_reappraisal_avg ~ par_intra_reappraisal_avg +
    ad_age + ad_gender + time_spent_avg + par_negative_affect + ad_negative_affect,
  data = df
)
summary(rq2a_reappraisal)
check_model(rq2a_reappraisal, check = c("linearity","outliers","vif","qq","homogeneity"))

## ACCEPTANCE
rq2a_acceptance <- lm(
  ad_intra_acceptance_avg ~ par_intra_acceptance_avg +
    ad_age + ad_gender + time_spent_avg + par_negative_affect + ad_negative_affect,
  data = df
)
summary(rq2a_acceptance)
check_model(rq2a_acceptance, check =c("linearity","outliers","vif","qq","homogeneity"))

## DISTRACTION
rq2a_distraction <- lm(
  ad_intra_distraction_avg ~ par_intra_distraction_avg +
    ad_age + ad_gender + time_spent_avg + par_negative_affect + ad_negative_affect,
  data = df
)
summary(rq2a_distraction)
check_model(rq2a_distraction, check = c("linearity","outliers","vif","qq","homogeneity"))

## SUPPRESSION
rq2a_suppression <- lm(
  ad_intra_suppression_avg ~ par_intra_suppression_avg +
    ad_age + ad_gender + time_spent_avg + par_negative_affect + ad_negative_affect,
  data = df
)
summary(rq2a_suppression)
check_model(rq2a_suppression, check = c("linearity","outliers","vif","qq","homogeneity"))
```

### summary and fdr

```{r}
modelsummary(
  list(
    "problem solving" = rq2a_problem_solving,
    "rumination"      = rq2a_rumination,
    "reappraisal"     = rq2a_reappraisal,
    "acceptance"      = rq2a_acceptance,
    "distraction"     = rq2a_distraction,
    "suppression"     = rq2a_suppression
  ),
  stars = TRUE,
  title = "RQ2a: Intra-personal ER strategy use similarity across the daily diary period",
  notes = "All models adjust for adolescent age, gender, time spent together, parent NA, and adolescent NA"
)

confint(rq2a_problem_solving, level = 0.95)
confint(rq2a_rumination, level = 0.95)
confint(rq2a_reappraisal, level = 0.95)
confint(rq2a_acceptance, level = 0.95)
confint(rq2a_distraction, level = 0.95)
confint(rq2a_suppression, level = 0.95)

rq2a_models <- list(
  problem_solving = rq2a_problem_solving,
  rumination      = rq2a_rumination,
  reappraisal     = rq2a_reappraisal,
  acceptance      = rq2a_acceptance,
  distraction     = rq2a_distraction,
  suppression     = rq2a_suppression
)

rq2a_preds <- c(
  "par_intra_problem_solving_avg",
  "par_intra_rumination_avg",
  "par_intra_reappraisal_avg",
  "par_intra_acceptance_avg",
  "par_intra_distraction_avg",
  "par_intra_suppression_avg"
)

rq2a_tests <- data.frame(
  model     = names(rq2a_models),
  predictor = rq2a_preds,
  stringsAsFactors = FALSE
)

rq2a_tests$p_raw <- mapply(function(m, p) {
  coef(summary(rq2a_models[[m]]))[p, "Pr(>|t|)"]
}, rq2a_tests$model, rq2a_tests$predictor)

rq2a_tests$p_fdr  <- p.adjust(rq2a_tests$p_raw, method = "BH")
rq2a_tests$signif <- rq2a_tests$p_fdr < 0.05

print(rq2a_tests)
```

## RQ3a. Does parents' mean level of interpersonal ER strategy use predict greater adolescent use of analogous intrapersonal ER strategies across the daily diary period?

### models

```{r}
## RQ3a: Parent interpersonal ER predicts adolescent intrapersonal ER (analogous)

## PROBLEM SOLVING
rq3a_problem_solving <- lm(
  ad_intra_problem_solving_avg ~ par_inter_problem_solving_avg +
    ad_age + ad_gender + time_spent_avg + par_negative_affect + ad_negative_affect,
  data = df
)
summary(rq3a_problem_solving)
check_model(rq3a_problem_solving, check = c("linearity","outliers","vif","qq"))

## RUMINATION
rq3a_rumination <- lm(
  ad_intra_rumination_avg ~ par_inter_corumination_avg +
    ad_age + ad_gender + time_spent_avg + par_negative_affect + ad_negative_affect,
  data = df
)
summary(rq3a_rumination)
check_model(rq3a_rumination, check = c("linearity","outliers","vif","qq"))

## REAPPRAISAL
rq3a_reappraisal <- lm(
  ad_intra_reappraisal_avg ~ par_inter_reappraisal_avg +
    ad_age + ad_gender + time_spent_avg + par_negative_affect + ad_negative_affect,
  data = df
)
summary(rq3a_reappraisal)
check_model(rq3a_reappraisal, check = c("linearity","outliers","vif","qq"))

## ACCEPTANCE
rq3a_acceptance <- lm(
  ad_intra_acceptance_avg ~ par_inter_acceptance_avg +
    ad_age + ad_gender + time_spent_avg + par_negative_affect + ad_negative_affect,
  data = df
)
summary(rq3a_acceptance)
check_model(rq3a_acceptance, check = c("linearity","outliers","vif","qq"))

## DISTRACTION
rq3a_distraction <- lm(
  ad_intra_distraction_avg ~ par_inter_distraction_avg +
    ad_age + ad_gender + time_spent_avg + par_negative_affect + ad_negative_affect,
  data = df
)
summary(rq3a_distraction)
check_model(rq3a_distraction, check = c("linearity","outliers","vif","qq"))

## SUPPRESSION
rq3a_suppression <- lm(
  ad_intra_suppression_avg ~ par_inter_suppression_avg +
    ad_age + ad_gender + time_spent_avg + par_negative_affect + ad_negative_affect,
  data = df
)
summary(rq3a_suppression)
check_model(rq3a_suppression, check = c("linearity","outliers","vif","qq"))

```

### summary and fdr

```{r}
confint(rq3a_problem_solving, level = 0.95)
confint(rq3a_rumination, level = 0.95)
confint(rq3a_reappraisal, level = 0.95)
confint(rq3a_acceptance, level = 0.95)
confint(rq3a_distraction, level = 0.95)
confint(rq3a_suppression, level = 0.95)

modelsummary(
  list(
    "problem solving" = rq3a_problem_solving,
    "corumination"    = rq3a_rumination,
    "reappraisal"     = rq3a_reappraisal,
    "acceptance"      = rq3a_acceptance,
    "distraction"     = rq3a_distraction,
    "suppression"     = rq3a_suppression
  ),
  stars = TRUE,
  title = "RQ3a: Mean-level associations between parent interpersonal and adolescent intrapersonal ER",
  notes = "All models adjust for adolescent age, gender, time spent together, parent NA, and adolescent NA"
)

rq3a_models <- list(
  problem_solving = rq3a_problem_solving,
  corumination    = rq3a_rumination,
  reappraisal     = rq3a_reappraisal,
  acceptance      = rq3a_acceptance,
  distraction     = rq3a_distraction,
  suppression     = rq3a_suppression
)

rq3a_preds <- c(
  "par_inter_problem_solving_avg",
  "par_inter_corumination_avg",
  "par_inter_reappraisal_avg",
  "par_inter_acceptance_avg",
  "par_inter_distraction_avg",
  "par_inter_suppression_avg"
)

rq3a_tests <- data.frame(
  model = names(rq3a_models),
  predictor = rq3a_preds,
  stringsAsFactors = FALSE
)

rq3a_tests$p_raw <- mapply(function(m, p) {
  coef(summary(rq3a_models[[m]]))[p, "Pr(>|t|)"]
}, rq3a_tests$model, rq3a_tests$predictor)

rq3a_tests <- rq3a_tests %>%
  mutate(
    p_fdr  = p.adjust(p_raw, method = "BH"),
    signif = p_fdr < 0.05
  )

print(rq3a_tests)
```

## Moderation models
```{r}
rq1a_corumination_age <- lm(
  ad_inter_corumination_avg ~ par_inter_corumination_avg *
    ad_age + ad_gender + time_spent_avg + par_negative_affect + ad_negative_affect,
  data = df
)
summary(rq1a_corumination_age)
check_model(rq1a_corumination_age, check = c("linearity","outliers","vif","qq"))

rq1a_corumination_gender <- lm(
  ad_inter_corumination_avg ~ par_inter_corumination_avg *
    ad_gender + ad_age + time_spent_avg + par_negative_affect + ad_negative_affect,
  data = df
)
summary(rq1a_corumination_gender)

rq3a_corumination_age <- lm(
  ad_intra_rumination_avg ~ par_inter_corumination_avg *
    ad_age + ad_gender + time_spent_avg + par_negative_affect + ad_negative_affect,
  data = df
)
summary(rq3a_corumination_age)
check_model(rq3a_corumination_age, check = c("linearity","outliers","vif","qq"))

rq3a_corumination_gender <- lm(
  ad_intra_rumination_avg ~ par_inter_corumination_avg *
    ad_gender + ad_age + time_spent_avg + par_negative_affect + ad_negative_affect,
  data = df
)
summary(rq3a_corumination_gender)
```

# Visualizations

## Visualization Set 1: Ridegline plots to show distribution of strategy use
```{r}
df %>%
  pivot_longer(
    cols = starts_with("ad_inter_"),
    names_to = "strategy",
    values_to = "value"
  ) %>%
  ggplot(aes(x = value, y = strategy, fill=strategy)) +
  scale_y_discrete(labels = c(
    "ad_inter_problem_solving_avg" = "Problem Solving",
    "ad_inter_corumination_avg"    = "Corumination",
    "ad_inter_reappraisal_avg"     = "Reappraisal",
    "ad_inter_acceptance_avg"      = "Acceptance",
    "ad_inter_distraction_avg"     = "Distraction",
    "ad_inter_suppression_avg"     = "Suppression"
  ), expand = c(0.01, 0)) +
  geom_density_ridges(alpha = .7) +
  theme_classic()  +
  labs(x = "Average Strategy Use (Mean-Centered)",
       y = "Interpersonal Strategy",
       title = "Distributions of Parents' Use of Interpersonal Strategies") +
  scale_x_continuous(expand = c(0.01, 0)) +
  theme(plot.title = element_text(size = 16, hjust = 0.5),
      axis.title = element_text(size = 12, face = "bold"),
      axis.text = element_text(size = 10),
      legend.position = "none"                          
  ) +
  scale_fill_brewer(palette="Set2")

df %>%
  pivot_longer(
    cols = starts_with("ad_intra_"),
    names_to = "strategy",
    values_to = "value"
  ) %>%
  ggplot(aes(x = value, y = strategy)) +
   scale_y_discrete(labels = c(
    "ad_intra_problem_solving_avg" = "Problem Solving",
    "ad_intra_rumination_avg"      = "Rumination",
    "ad_intra_reappraisal_avg"     = "Reappraisal",
    "ad_intra_acceptance_avg"      = "Acceptance",
    "ad_intra_distraction_avg"     = "Distraction",
    "ad_intra_suppression_avg"     = "Suppression"
  ), expand = c(0.01, 0)) +
  geom_density_ridges() +
  theme_classic()  +
  scale_x_continuous(expand = c(0.01, 0))

df %>%
  pivot_longer(
    cols = starts_with("par_inter_"),
    names_to = "strategy",
    values_to = "value"
  ) %>%
  ggplot(aes(x = value, y = strategy)) +
     scale_y_discrete(labels = c(
    "par_inter_problem_solving_avg" = "Problem Solving",
    "par_inter_corumination_avg"    = "Corumination",
    "par_inter_reappraisal_avg"     = "Reappraisal",
    "par_inter_acceptance_avg"      = "Acceptance",
    "par_inter_distraction_avg"     = "Distraction",
    "par_inter_suppression_avg"     = "Suppression"
  ), expand = c(0.01, 0)) +
  geom_density_ridges() +
  theme_classic()  +
  scale_x_continuous(expand = c(0.01, 0))


df %>%
  pivot_longer(
    cols = starts_with("par_intra_"),
    names_to = "strategy",
    values_to = "value"
  ) %>%
  ggplot(aes(x = value, y = strategy)) +
  scale_y_discrete(labels = c(
    "par_intra_problem_solving_avg" = "Problem Solving",
    "par_intra_rumination_avg"      = "Rumination",
    "par_intra_reappraisal_avg"     = "Reappraisal",
    "par_intra_acceptance_avg"      = "Acceptance",
    "par_intra_distraction_avg"     = "Distraction",
    "par_intra_suppression_avg"     = "Suppression"
  ), expand = c(0.01, 0)) +
  geom_density_ridges() +
  theme_classic()  +
  scale_x_continuous(expand = c(0.01, 0))
```

## Visualization Set 2: Heat map to show the magnitude of the associations for each strategy pair
```{r}
names1 <- c(
  problem_solving = "Problem Solving",
  corumination    = "Corumination",
  reappraisal     = "Reappraisal",
  acceptance      = "Acceptance",
  distraction     = "Distraction",
  suppression     = "Suppression"
)

betas <- c(
  problem_solving = coef(rq1a_problem_solving)["par_inter_problem_solving_avg"],
  corumination    = coef(rq1a_corumination)["par_inter_corumination_avg"],
  reappraisal     = coef(rq1a_reappraisal)["par_inter_reappraisal_avg"],
  acceptance      = coef(rq1a_acceptance)["par_inter_acceptance_avg"],
  distraction     = coef(rq1a_distraction)["par_inter_distraction_avg"],
  suppression     = coef(rq1a_suppression)["par_inter_suppression_avg"]
)

df1 <- data.frame(
  label = names1,
  beta  = as.numeric(betas)
)

ggplot(df1, aes(label, label, fill = beta)) +
  geom_tile(color = "white") +
  geom_text(aes(label = round(beta, 3))) +
  scale_fill_viridis_c(option = "G", na.value = "white", limits = c(-0.3, 0.3)) +
  labs(
    title = "Parent-Adolescent Interpersonal ER Strategy Use Correspondence",
    fill = "Beta"
  ) +
  theme_classic()

ggplot(df1, aes(1, label, fill = beta)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(round(beta, 3), ifelse(label %in% c("Corumination","Distraction","Suppression"), "*", "")))) +
  scale_fill_viridis_c(option = "G", na.value = "white", limits = c(-0.3, 0.3)) +
  labs(
    title = "Parent-Adolescent Interpersonal ER Strategy Use Correspondence",
    fill = "β",
    y = "Interpersonal ER Strategy",
    caption = expression("* " * italic(p) * " < .05")
  ) +
  theme_classic() +
  theme(
    axis.text.x=element_blank(),
    axis.title.x=element_blank(),
    axis.ticks.x=element_blank()
  )
```

## Visualization Set 3: Moderation plots to show significant interaction effects across adolescent age and gender

```{r}
# Unfortunately no moderations were significant, so I will present the significant linear models for each rq instead
ggplot(df, aes(x = par_inter_corumination_avg, y = ad_inter_corumination_avg)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  labs(
    x = "Parent Interpersonal Corumination",
    y = "Adolescent Interpersonal Corumination",
   title = "Corumination"
  ) +
  scale_x_continuous(expand = c(0.01, 0)) +
  scale_y_continuous(expand = c(0.01, 0)) +
  theme_classic()

ggplot(df, aes(x = par_inter_distraction_avg, y = ad_inter_distraction_avg)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  labs(
    x = "Parent Interpersonal Distraction",
    y = "Adolescent Interpersonal Distraction",
    title = "Distraction"
  ) + 
  scale_x_continuous(expand = c(0.01, 0)) +
  scale_y_continuous(expand = c(0.01, 0)) +
  theme_classic()


ggplot(df, aes(x = par_inter_suppression_avg, y = ad_inter_suppression_avg)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  labs(
    x = "Parent Interpersonal Suppression",
    y = "Adolescent Interpersonal Suppression",
    title = "Suppression"
  ) +
  scale_x_continuous(expand = c(0.01, 0)) +
  scale_y_continuous(expand = c(0.01, 0)) +
  theme_classic()

ggplot(df, aes(x = par_inter_corumination_avg, y = ad_intra_rumination_avg)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  labs(
    x = "Parent Interpersonal Corumination",
    y = "Adolescent Intrapersonal Rumination",
   title = "Corumination-Rumination"
  ) +
  scale_x_continuous(expand = c(0.01, 0)) +
  scale_y_continuous(expand = c(0.01, 0)) +
  theme_classic()
```